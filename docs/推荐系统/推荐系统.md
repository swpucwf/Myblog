## 推荐系统介绍

### 什么是推荐系统呢？

利用 电子商务网站向客户提供商品信息和建议，帮助用户决定应该购买什么产品，模拟销售人员帮助客户完成购买过程。个性化推荐是根据用户的兴趣特点和购买行为，向用户推荐用户感兴趣的信息和商品。

### 推荐

精准推荐，信息化时代，数据量大，如何做到精准推送。

#### 1.用户行为决定推荐内容

#### 2.推荐内容多样化

#### 3. 推荐感兴趣的，可能喜欢的

### 推荐系统的需求性

- 提高整体收益，长尾商品推销
- 通过用户行为来进行个性化推荐

### 应用

个性化推荐，优化用户体验，海量数据中快速定位，精准营销

### 目标

Relevance：推荐的东西，相关性
Novelty：新颖的才好，创新性
Serendipity：机缘性
Diversity：多样性

### 如何评价推荐系统效果

1. 用户满意度

2. 

3. 常规计算损失
   $$
   \mathrm{RMSE}=\sqrt{\frac{1}{|\mathcal{T}|} \sum_{(u, i) \in \mathcal{T}}\left(\hat{r}_{u i}-r_{u i}\right)^{2}}
   $$

$$
\text { (T是测试集) }
$$

3. TopK推荐: 
   $$
   precision@K =\frac{\left|\operatorname{Rel}_{u} \cap \operatorname{Rec}_{u}\right|}{\left|\operatorname{Rec}_{u}\right|}
   $$

   (用户相关商吕集与推荐商品集的交集)

4. 覆盖率：挖掘长尾；多样性：覆盖不同领域；实时性：刚买了房子赶紧推装修

### 推荐系统里的常用词

- Item：商品，例如要从拼多多买的9.9包邮的拖鞋
- Embedding：隐向量，例如对用户商品评分矩阵进行分解
- 召回：粗略计算要返回结果，例如先从100W商品中取比较可能的100个
- 打分：要排名得有一个统一的标准；重排：最终结果排序

### 推荐系统经典流程

- 离线+近线+在线（召回+粗排+精排）
- 离线通常跑较大的模型与算法，先得到当前数据的大致结果，一定时间更新一次
- 粗排通常会跟着用户走，用户做了什么事，推荐结果也会随之更新
- 在线模块需要根据业务规则来返回最终呈现结果

### 推荐系统难点与挑战

- 需要更广泛的收集用户标签并画像
- 人是善变的，随着时间的推移，兴趣也会改变
- 根据固定画像数据，推荐结果可不能固定不变
- 特征工程如何构建一直是一个大难题
- 冷启动怎么办，包括用户冷启动与商品冷启动
- 新用户来了，不知道他啥样怎么办
- 商品倒是好办，属性相对固定
- 解决方法比较多，例如直接推荐销冠

### 涉及技术点分析

- Embedding方向：如何更好的表示数据，肯定不用one-hot
- 隐向量的方法在推荐中几乎无处不用，例如常见的FM及其DeepFM算法

![image-20220612011019670](images/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/image-20220612011019670.png)

- NLP方向：如何基于文本数据来进行推荐？
- 文本处理方法比较多，LDA,词向量,矩阵分解等套路都能用得上

![image-20220612011043059](images/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/image-20220612011043059.png)

- 知识图谱方向：现在这么火的技术点，推荐中肯定也用到了
- 数据越多，越能体现出知识图谱的强大

![image-20220612011057875](images/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/image-20220612011057875.png)

- CV方向：卷积与图卷积，图像与视频数据也是用户行为中的体现
- 卷积不仅仅能应用在图像/视频数据中，矩阵数据都可以尝试

![image-20220612011129004](images/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/image-20220612011129004.png)

- 特征工程与深度学习方向：如何更好的利用这么多信息？深度学习天生优胜！
- 数据维度大，稀疏度高一直都是一个大难题，与深度学习结合能更简单

![image-20220612011144074](images/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/image-20220612011144074.png)

### 深度学习必要性

- 宏观：传统人工特征工程难度较大，深度学习可以把特征做的更好
- 本质：end2end的架构让模型训练起来更容易，项目做起来更简单！
- 深度学习更适合NLP与图像数据，符合当下用户行为数据
- 但凡看到深度学习，第一感觉应该是这件事做起来没那么麻烦了，深度学习自动提取特征的特征方便

### 推荐和搜索的区别

搜索和推荐都是解决互联网大数据时代信息过载的手段，但是它们也存在着许多的不同：

1. **用户意图**：搜索时的用户意图是非常明确的，用户通过查询的关键词主动发起搜索请求。对于推荐而言，用户的需求是不明确的，推荐系统在通过对用户历史兴趣的分析给用户推荐他们可能感兴趣的内容。
2. **个性化程度**：对于搜索而言，由于限定的了搜索词，所以展示的内容对于用户来说是有标准答案的，所以搜索的个性化程度较低。而对于推荐来说，推荐的内容本身就是没有标准答案的，每个人都有不同的兴趣，所以每个人展示的内容，个性化程度比较强。
3. **优化目标**：对于搜索系统而言，更希望可以快速地、准确地定位到标准答案，所以希望搜索结果中答案越靠前越好，通常评价指标有：归一化折损累计收益（NDCG）、精确率（Precision）和召回率（Recall）。对于推荐系统而言，因为没有标准的答案，所以优化目标可能会更宽泛。例如用户停留时长、点击、多样性，评分等。不同的优化目标又可以拆解成具体的不同的评价指标。
4. **马太效应和长尾理论**：对于搜索系统来说，用户的点击基本都集中在排列靠前的内容上，对于排列靠后的很少会被关注，这就是马太效应。而对于推荐系统来说，热门物品被用户关注更多，冷门物品不怎么被关注的现象也是存在的，所以也存在马太效应。此外，在推荐系统中，冷门物品的数量远远高于热门物品的数量，所以物品的长尾性非常明显。

### 推荐系统架构

系统架构设计思想是大数据背景下如何有效利用海量和实时数据，将推荐系统按照对数据利用情况和系统响应要求出发，将整个架构分为**离线层、近线层、在线层**三个模块。

推荐系统架构，首先从数据驱动角度，对于数据，最简单的方法是存下来，留作后续离线处理，**离线层**就是我们用来管理离线作业的部分架构。**在线层**能更快地响应最近的事件和用户交互，但必须实时完成。这会限制使用算法的复杂性和处理的数据量。离线计算对于数据数量和算法复杂度限制更少，因为它以批量方式完成，没有很强的时间要求。不过，由于没有及时加入最新的数据，所以很容易过时。

个性化架构的关键问题，就是如何以无缝方式结合、管理在线和离线计算过程。**近线层**介于两种方法之间，可以执行类似于在线计算的方法，但又不必以实时方式完成。这种设计思想最经典的就是Netflix在2013年提出的架构，整个架构分为

#### 离线层：不用实时数据，不提供实时响应；

##### 介绍

离线层是计算量最大的一个部分，它的特点是不依赖实时数据，也不需要实时提供服务。需要实现的主要功能模块是：

1. 数据处理、数据存储；
2. 特征工程、离线特征计算；
3. 离线模型的训练；

#### 优势

1. 可以处理大量的数据，进行大规模特征工程；
2. 可以进行批量处理和计算；
3. 不用有响应时间要求；

#### 近线层：使用实时数据，不保证实时响应；

1. 特征的事实更新计算：例如统计用户对不同type的ctr，推荐系统一个老生常谈的问题就是特征分布不一致怎么办，如果使用离线算好的特征就容易出现这个问题。近线层能够获取实时数据，按照用户的实时兴趣计算就能很好避免这个问题。
2. 实时训练数据的获取：比如在使用DIN、DSIN这行网络会依赖于用户的实时兴趣变化，用户几分钟前的点击就可以通过近线层获取特征输入模型。
3. 模型实时训练：可以通过在线学习的方法更新模型，实时推送到线上；

![在这里插入图片描述](images/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/%E5%9B%BE%E7%89%87image-20220409205830027.png)

#### 在线层：使用实时数据，保证实时在线服务；

1. 模型在线服务；包括了快速召回和排序；
2. 在线特征快速处理拼接：：根据传入的用户ID和场景，快速读取特征和处理；
3. AB实验或者分流：根据不同用户采用不一样的模型，比如冷启动用户和正常服务模型；
4. 运筹优化和业务干预：比如要对特殊商家流量扶持、对某些内容限流；

### 四阶段

![在这里插入图片描述](images/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/%E5%9B%BE%E7%89%87image-20220409211354342.png)

##### 召回

召回主要考虑的内容有：

1. **考虑用户层面**：用户兴趣的多元化，用户需求与场景的多元化：例如：新闻需求，重大要闻，相关内容沉浸阅读等等
2. **考虑系统层面**：增强系统的鲁棒性；部分召回失效，其余召回队列兜底不会导致整个召回层失效；排序层失效，召回队列兜底不会导致整个推荐系统失效
3. **系统多样性内容分发**：图文、视频、小视频；精准、试探、时效一定比例；召回目标的多元化，例如：相关性，沉浸时长，时效性，特色内容等等
4. **可解释性推荐一部分召回是有明确推荐理由的**：很好的解决产品性数据的引入；

##### 粗排

粗排的原因是有时候召回的结果还是太多，精排层速度还是跟不上，所以加入粗排。粗排可以理解为精排前的一轮过滤机制，减轻精排模块的压力。粗排介于召回和精排之间，要同时兼顾精准性和低延迟。目前粗排一般也都模型化了，其训练样本类似于精排，选取曝光点击为正样本，曝光未点击为负样本。但由于粗排一般面向上万的候选集，而精排只有几百上千，其解空间大很多。

粗排阶段的架构设计主要是考虑三个方面，一个是根据精排模型中的重要特征，来做候选集的截断，另一部分是有一些召回设计，比如热度或者语义相关的这些结果，仅考虑了item侧的特征，可以用粗排模型来排序跟当前User之间的相关性，据此来做截断，这样是比单独的按照item侧的倒排分数截断得到更加个性化的结果，最后是算法的选型要在在线服务的性能上有保证，因为这个阶段在pipeline中完成从召回到精排的截断工作，在延迟允许的范围内能处理更多的召回候选集理论上与精排效果正相关。

### torch-rechub 安装

```
pip install torch-rechub
```



![image-20220614233135897](images/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/image-20220614233135897.png)